---
slug: malware_analysis_lab
title: Introductory Malware Analysis Lab
authors: nathan
tags: [defense, practical, networking]
sidebar_position: 1
---





# Introduction
I recently accepted a Threat Hunting internship for this summer and I asked my future employer what's some technologies or tools I should research before starting. They gave me a list of some frameworks and tools but some notable items were:
1. Familiarize myself with a popular SIEM.
2. Understand attacker behavior and map TTPs to the MITRE ATT&CK Framework.
3. Stay up to date on emerging threats and CVEs.

<!--truncate-->
I figured the best way to accomplish 1-2 (and partially 3) was to create my own malware analysis lab using my decently high spec'd NUC I had lying around. Instead of going into how to setup this network i'll describe some uses and potential learning activities you can do on a similar setup.

# Diagram

![image](/img/mal_lab/diagram.png)
**IMPORTANT**: Make sure this network is properly segmented! The last thing you want to do is wake up one day and have your entire network locked by ransomware.
## Services Used:
### Windows Log Generation:  
#### [Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)  
#### [Config](https://github.com/SwiftOnSecurity/sysmon-config)  
 
Sysmon is pretty ubiquitous with windows log generation and monitoring. Extremely easy to setup and deploy network wide. It even has a linux port! SwiftOnSecurity's Sysmon config is also the config I learned in school and the one that I personally prefer, although [modular sysmon](https://github.com/olafhartong/sysmon-modular) is a good choice as well but it was generating too much noise in my environment.

### Linux Log Generation:  
#### Auditd  
While sysmon does have a linux port I wanted to learn more about auditd itself (as I'm potentially using it in an upcoming competition) so again, this environment felt like the best place to do that. I won't bore you with the details on auditd but it's essentially used to create audit records for various events that happen during runtime, things like processes, network activity, etc. For a more detailed explanation I highly suggest you check out [this blog post.](https://izyknows.medium.com/linux-auditd-for-threat-detection-d06c8b941505)  

### Log Fowarding:  
#### Splunk Universal Fowarder  
Pretty self-explanatory as i'm using splunk as my SIEM. This is used to forward system logs to splunk, decently easy to configure as well.  

### Endpoint Visibility and Querying:
#### [osquery](https://osquery.io/)  
#### [Config](https://github.com/CptOfEvilMinions/ChooseYourSIEMAdventure/tree/main/conf/osquery)  
While this isn't necessary, I really wanted to learn more about osquery and this was the perfect environment to try it out. In short it gives an SQL like syntax to querying devices for information and allows queries to be ran on a schedule. It also has the ability to run YARA rules, something I've been experimenting with heavily (expect a post about this soon(ish)). 

### Intrusion Detection System:  
#### [Suricata](https://suricata.io/)  
It's the industry standard and also what I'm currently using at my work as a Student Threat Hunter at PISCES. It's also fairly easy to configure on [PFSense.](https://hurricanelabs.com/splunk-tutorials/your-all-in-one-guide-to-setting-up-pfsense-and-suricata-in-splunk/)  


## Hosts
This part is up to you, if you want to focus only on windows, just make a couple windows hosts and configure them with the services described above. I decided to go with one Windows machine and one Linux. I also *highly* suggest you setup an attack machine. This enables you to not only practice red teaming but also allows you to start attacks from that machine and view them in whatever SIEM you use.


# Activities
Once you get this network setup here's some interesting activities you can do to improve your blue/red team skills.
- Simulate malicious network activity with [flightsim](https://github.com/alphasoc/flightsim)
	- This nifty little program allows you to simulate malicious network activity safely. You can use this to test Suricata rules and/or firewalls. 
- Simulate attacks and write rules.
	- With an attack box setup you can simulate attacks on the other hosts in the lab environment. This can range from simple vulnerability scanning all the way to active exploitation with tools like meterpreter or even cobalt strike (if you have a copy). Afterwards you can write IDS rules and SIEM alerts to detect on this activity.
- Detonate malware.
	- This was the main reason I created my own lab. While static analysis of malware is nice, dynamic analysis and writing rules to accompany malicious activity is what excites me. My philosophy is that some lone sysadmin doesn't care (or have the time to learn) about what functions or methods a piece of malware uses, but writing IDS rules to detect on this activity has the possibility to help those sysadmins immensely. Since this lab *should* be virtualized and segmented away from any other network, the ability to use snapshots to revert machines to a state prior to detonation is a great tool to get systems back up fast. Always make snapshots before detonating or simulating malicous activity in your lab.

These are just a few of the potential activities you can do once you get this network setup. The possibilities are truly endless and the opportunity for learning more is even more limitless.

Keep an eye on my blog for my thoughts on the various services used here. With this network setup i'll be able to go more in-depth when analyzing malware so keep an eye out for those posts soon!

As always thanks for reading, If you have any suggestions or feedback please don't hesititate to [contact me.](mailto:nathan@nburns.tech?Subject=MalwareLabPost).

